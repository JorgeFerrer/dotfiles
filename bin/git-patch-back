#!/bin/bash
DEFAULT_PATCH_DIR="/Volumes/Dev/Liferay/EE/liferay-portal-ee-6.0.x"
output_dir="${2:-$DEFAULT_PATCH_DIR}";
patch_name="$output_dir/$1.patch";
ref_spec=$(git get-custom-refspec $1);

git diff -p --full-index $ref_spec > $patch_name;
cd ${output_dir};

patch_out=$(git apply -v --whitespace=fix $patch_name 2>&1);

error_out=$(echo "$patch_out" | grep -E '^error: patch failed:([^:]+):' | sed 's/^error: patch failed: \([^:]*\)\(:.*\)$/\1/g' | uniq);

if [[ -z $error_out ]]; then
	echo "$patch_out";
else
	echo "ERROR: The following files could not be patched:"
	echo $error_out
fi